<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小轩网页抓包 - 小说抓取工具</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        accent: '#60a5fa',
                        neutral: '#f3f4f6',
                        'neutral-dark': '#9ca3af'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .bg-gradient-blue {
                background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: #9ca3af;
                border-radius: 3px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb:hover {
                background: #6b7280;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航 -->
    <header class="bg-gradient-blue text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-code-fork text-2xl"></i>
                <h1 class="text-2xl font-bold text-shadow">小轩网页抓包</h1>
            </div>
            <div class="text-sm">
                <span class="bg-white/20 px-3 py-1 rounded-full">小说抓取工具</span>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 步骤指示器 -->
        <div class="flex justify-between mb-8 max-w-3xl mx-auto">
            <div id="step1-indicator" class="flex flex-col items-center">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center mb-2">
                    <i class="fa fa-link"></i>
                </div>
                <span class="text-sm font-medium">输入网址</span>
            </div>
            <div class="flex-1 border-t-2 border-gray-300 self-center mx-2" id="step1-2-line"></div>
            <div id="step2-indicator" class="flex flex-col items-center">
                <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center mb-2">
                    <i class="fa fa-list"></i>
                </div>
                <span class="text-sm font-medium text-gray-500">选择章节</span>
            </div>
            <div class="flex-1 border-t-2 border-gray-300 self-center mx-2" id="step2-3-line"></div>
            <div id="step3-indicator" class="flex flex-col items-center">
                <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center mb-2">
                    <i class="fa fa-download"></i>
                </div>
                <span class="text-sm font-medium text-gray-500">下载小说</span>
            </div>
        </div>

        <!-- 步骤1：URL输入区 -->
        <section id="step1" class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fa fa-link text-primary mr-2"></i>
                输入小说网址
            </h2>
            <div class="mb-4">
                <div class="flex">
                    <input 
                        type="url" 
                        id="novel-url" 
                        placeholder="请输入小说章节列表页或第一章的URL" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                    <button 
                        id="validate-url" 
                        class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-r-lg transition-all-300 flex items-center"
                    >
                        <i class="fa fa-check-circle mr-2"></i>
                        验证
                    </button>
                </div>
                <p id="url-hint" class="mt-2 text-sm text-gray-500 hidden"></p>
            </div>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-4 hidden" id="url-tips">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa fa-info-circle text-blue-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <span class="font-medium">支持的网站：</span> 
                            大多数主流小说网站，如笔趣阁、顶点小说等。
                            如果遇到问题，请尝试更换网站或检查网络连接。
                        </p>
                    </div>
                </div>
            </div>
            
            <div id="loading-indicator" class="hidden">
                <div class="flex items-center justify-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                    <span class="ml-2 text-gray-600">正在验证网址...</span>
                </div>
            </div>
            
            <div id="error-message" class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg hidden">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa fa-exclamation-circle text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700" id="error-text"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 步骤2：章节选择区 -->
        <section id="step2" class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fa fa-list text-primary mr-2"></i>
                选择章节
            </h2>
            
            <div class="mb-4 flex flex-wrap gap-2">
                <button id="select-all" class="bg-primary hover:bg-primary/90 text-white px-4 py-1 rounded-full text-sm transition-all-300">
                    <i class="fa fa-check-square-o mr-1"></i>
                    全选
                </button>
                <button id="select-none" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-1 rounded-full text-sm transition-all-300">
                    <i class="fa fa-square-o mr-1"></i>
                    取消全选
                </button>
                <button id="select-reverse" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-1 rounded-full text-sm transition-all-300">
                    <i class="fa fa-exchange mr-1"></i>
                    反选
                </button>
                <div class="ml-auto flex items-center">
                    <span class="text-sm text-gray-600 mr-2">已选择：</span>
                    <span id="selected-count" class="font-medium">0</span>
                    <span class="text-sm text-gray-600 mx-1">/</span>
                    <span id="total-count" class="text-sm text-gray-600">0</span>
                </div>
            </div>
            
            <div class="border border-gray-200 rounded-lg mb-4">
                <div class="max-h-60 overflow-y-auto scrollbar-thin" id="chapter-list">
                    <!-- 章节列表将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <input type="checkbox" id="auto-save" class="mr-2" checked>
                    <label for="auto-save" class="text-sm text-gray-700">抓取完成后自动下载</label>
                </div>
                <button id="start-crawl" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-all-300 flex items-center">
                    <i class="fa fa-play-circle mr-2"></i>
                    开始抓取
                </button>
            </div>
        </section>

        <!-- 步骤3：抓取进度区 -->
        <section id="step3" class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fa fa-spinner text-primary mr-2"></i>
                抓取进度
            </h2>
            
            <div class="mb-4">
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">总进度</span>
                    <span id="progress-percentage" class="text-sm font-medium text-primary">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">当前状态</span>
                    <span id="current-status" class="text-sm font-medium text-primary">准备中...</span>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div id="current-chapter" class="text-sm text-gray-700">等待开始...</div>
                </div>
            </div>
            
            <div class="mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">抓取日志</h3>
                <div class="border border-gray-200 rounded-lg bg-gray-50 p-3 h-40 overflow-y-auto scrollbar-thin">
                    <ul id="crawl-log" class="text-sm space-y-1">
                        <li class="text-gray-600"><i class="fa fa-info-circle text-blue-500 mr-1"></i> 准备开始抓取...</li>
                    </ul>
                </div>
            </div>
            
            <div class="flex justify-between">
                <button id="pause-crawl" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-all-300 flex items-center hidden">
                    <i class="fa fa-pause mr-2"></i>
                    暂停
                </button>
                <button id="resume-crawl" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all-300 flex items-center hidden">
                    <i class="fa fa-play mr-2"></i>
                    继续
                </button>
                <button id="stop-crawl" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all-300 flex items-center">
                    <i class="fa fa-stop mr-2"></i>
                    停止
                </button>
            </div>
        </section>

        <!-- 步骤4：结果下载区 -->
        <section id="step4" class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fa fa-check-circle text-green-500 mr-2"></i>
                抓取完成
            </h2>
            
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-gray-800">小说信息</h3>
                    <span class="text-sm text-green-600 font-medium">
                        <i class="fa fa-check-circle mr-1"></i>
                        已完成
                    </span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">小说名称</p>
                        <p id="novel-title" class="font-medium text-gray-800">未知</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">作者</p>
                        <p id="novel-author" class="font-medium text-gray-800">未知</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">抓取章节数</p>
                        <p id="crawled-chapters" class="font-medium text-gray-800">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">文件大小</p>
                        <p id="file-size" class="font-medium text-gray-800">0 KB</p>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-medium text-gray-800 mb-3">内容预览</h3>
                <div class="border border-gray-200 rounded-lg bg-gray-50 p-4 h-40 overflow-y-auto scrollbar-thin">
                    <pre id="content-preview" class="text-sm text-gray-700 whitespace-pre-wrap">暂无预览内容...</pre>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3 justify-between">
                <button id="back-to-step1" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-all-300 flex items-center">
                    <i class="fa fa-arrow-left mr-2"></i>
                    重新开始
                </button>
                <div>
                    <button id="download-txt" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-all-300 flex items-center">
                        <i class="fa fa-download mr-2"></i>
                        下载TXT文件
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- 底部信息 -->
    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-lg font-bold flex items-center">
                        <i class="fa fa-code-fork mr-2"></i>
                        小轩网页抓包
                    </h3>
                    <p class="text-gray-400 text-sm mt-1">简单高效的小说抓取工具</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-400 hover:text-white transition-all-300">
                        <i class="fa fa-question-circle"></i>
                        <span class="ml-1">使用帮助</span>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-all-300">
                        <i class="fa fa-github"></i>
                        <span class="ml-1">源码</span>
                    </a>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700 text-center text-gray-400 text-sm">
                <p>© 2025 小轩网页抓包 - 仅供个人学习使用，请勿用于商业用途</p>
            </div>
        </div>
    </footer>

    <!-- 设置弹窗 -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">抓取设置</h3>
                <button id="close-settings" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">请求间隔 (毫秒)</label>
                    <input type="number" id="request-interval" min="500" max="5000" value="1000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">建议值：1000-2000，值越大越稳定但速度越慢</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">超时时间 (秒)</label>
                    <input type="number" id="timeout" min="10" max="60" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">建议值：30-60，网络不稳定时可适当增大</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">重试次数</label>
                    <input type="number" id="retry-count" min="0" max="5" value="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">请求失败时的重试次数，建议值：2-3</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User-Agent</label>
                    <input type="text" id="user-agent" value="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">模拟浏览器标识，一般无需修改</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="save-settings" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all-300">
                    保存设置
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        const novelData = {
            url: '',
            title: '',
            author: '',
            chapters: [],
            content: {},
            settings: {
                requestInterval: 1000,
                timeout: 30,
                retryCount: 3,
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }
        };
        
        let crawlStatus = {
            isRunning: false,
            isPaused: false,
            currentChapter: 0,
            totalChapters: 0,
            selectedChapters: [],
            retryCount: 0
        };

        // DOM元素
        const elements = {
            // 步骤指示器
            step1Indicator: document.getElementById('step1-indicator'),
            step2Indicator: document.getElementById('step2-indicator'),
            step3Indicator: document.getElementById('step3-indicator'),
            step12Line: document.getElementById('step1-2-line'),
            step23Line: document.getElementById('step2-3-line'),
            
            // 步骤1元素
            novelUrl: document.getElementById('novel-url'),
            validateUrl: document.getElementById('validate-url'),
            urlHint: document.getElementById('url-hint'),
            urlTips: document.getElementById('url-tips'),
            loadingIndicator: document.getElementById('loading-indicator'),
            errorMessage: document.getElementById('error-message'),
            errorText: document.getElementById('error-text'),
            
            // 步骤2元素
            chapterList: document.getElementById('chapter-list'),
            selectAll: document.getElementById('select-all'),
            selectNone: document.getElementById('select-none'),
            selectReverse: document.getElementById('select-reverse'),
            selectedCount: document.getElementById('selected-count'),
            totalCount: document.getElementById('total-count'),
            autoSave: document.getElementById('auto-save'),
            startCrawl: document.getElementById('start-crawl'),
            
            // 步骤3元素
            progressBar: document.getElementById('progress-bar'),
            progressPercentage: document.getElementById('progress-percentage'),
            currentStatus: document.getElementById('current-status'),
            currentChapter: document.getElementById('current-chapter'),
            crawlLog: document.getElementById('crawl-log'),
            pauseCrawl: document.getElementById('pause-crawl'),
            resumeCrawl: document.getElementById('resume-crawl'),
            stopCrawl: document.getElementById('stop-crawl'),
            
            // 步骤4元素
            novelTitle: document.getElementById('novel-title'),
            novelAuthor: document.getElementById('novel-author'),
            crawledChapters: document.getElementById('crawled-chapters'),
            fileSize: document.getElementById('file-size'),
            contentPreview: document.getElementById('content-preview'),
            backToStep1: document.getElementById('back-to-step1'),
            downloadTxt: document.getElementById('download-txt'),
            
            // 设置弹窗
            settingsModal: document.getElementById('settings-modal'),
            closeSettings: document.getElementById('close-settings'),
            saveSettings: document.getElementById('save-settings'),
            requestInterval: document.getElementById('request-interval'),
            timeout: document.getElementById('timeout'),
            retryCount: document.getElementById('retry-count'),
            userAgent: document.getElementById('user-agent')
        };

        // 步骤区域
        const steps = {
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            step3: document.getElementById('step3'),
            step4: document.getElementById('step4')
        };

        // 初始化
        function init() {
            // 加载设置
            loadSettings();
            
            // 绑定事件
            bindEvents();
            
            // 显示URL提示
            setTimeout(() => {
                elements.urlTips.classList.remove('hidden');
            }, 1000);
        }

        // 绑定事件
        function bindEvents() {
            // 步骤1事件
            elements.validateUrl.addEventListener('click', validateUrl);
            elements.novelUrl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') validateUrl();
            });
            
            // 步骤2事件
            elements.selectAll.addEventListener('click', selectAllChapters);
            elements.selectNone.addEventListener('click', selectNoneChapters);
            elements.selectReverse.addEventListener('click', selectReverseChapters);
            elements.startCrawl.addEventListener('click', startCrawl);
            
            // 步骤3事件
            elements.pauseCrawl.addEventListener('click', pauseCrawl);
            elements.resumeCrawl.addEventListener('click', resumeCrawl);
            elements.stopCrawl.addEventListener('click', stopCrawl);
            
            // 步骤4事件
            elements.backToStep1.addEventListener('click', backToStep1);
            elements.downloadTxt.addEventListener('click', downloadTxt);
            
            // 设置弹窗事件
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    elements.settingsModal.classList.add('hidden');
                }
            });
        }

        // 加载设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('xiaoxuan-crawler-settings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    novelData.settings = { ...novelData.settings, ...settings };
                    
                    // 更新设置表单
                    elements.requestInterval.value = novelData.settings.requestInterval;
                    elements.timeout.value = novelData.settings.timeout;
                    elements.retryCount.value = novelData.settings.retryCount;
                    elements.userAgent.value = novelData.settings.userAgent;
                } catch (e) {
                    console.error('加载设置失败:', e);
                }
            }
        }

        // 保存设置
        function saveSettings() {
            novelData.settings.requestInterval = parseInt(elements.requestInterval.value);
            novelData.settings.timeout = parseInt(elements.timeout.value);
            novelData.settings.retryCount = parseInt(elements.retryCount.value);
            novelData.settings.userAgent = elements.userAgent.value;
            
            localStorage.setItem('xiaoxuan-crawler-settings', JSON.stringify(novelData.settings));
        }

        // 验证URL
        async function validateUrl() {
            const url = elements.novelUrl.value.trim();
            if (!url) {
                showError('请输入小说网址');
                return;
            }
            
            // 重置错误信息
            hideError();
            
            // 显示加载指示器
            elements.loadingIndicator.classList.remove('hidden');
            elements.validateUrl.disabled = true;
            
            try {
                // 检查URL格式
                if (!isValidUrl(url)) {
                    throw new Error('无效的URL格式');
                }
                
                novelData.url = url;
                
                // 尝试获取章节列表
                await fetchChapterList(url);
                
                // 更新步骤指示器
                updateStepIndicator(2);
                
                // 显示步骤2
                showStep(2);
                
                // 填充章节列表
                renderChapterList();
                
            } catch (error) {
                console.error('验证URL失败:', error);
                showError(error.message || '验证URL失败，请检查网址是否正确');
            } finally {
                // 隐藏加载指示器
                elements.loadingIndicator.classList.add('hidden');
                elements.validateUrl.disabled = false;
            }
        }

        // 检查URL是否有效
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }

        // 获取章节列表
        async function fetchChapterList(url) {
            try {
                // 模拟获取章节列表
                // 在实际应用中，这里应该根据不同网站的结构进行解析
                const response = await fetchWithTimeout(url, {
                    method: 'GET',
                    headers: {
                        'User-Agent': novelData.settings.userAgent,
                        'Referer': url
                    }
                });
                
                const html = await response.text();
                
                // 解析HTML获取章节列表
                // 这里使用简化的解析逻辑，实际应用中需要根据不同网站定制
                const chapters = parseChapterList(html, url);
                
                if (!chapters || chapters.length === 0) {
                    throw new Error('无法获取章节列表，请检查网址是否正确');
                }
                
                novelData.chapters = chapters;
                
                // 尝试提取小说标题和作者
                novelData.title = extractNovelTitle(html) || '未知小说';
                novelData.author = extractNovelAuthor(html) || '未知作者';
                
                return chapters;
            } catch (error) {
                console.error('获取章节列表失败:', error);
                throw new Error(`获取章节列表失败: ${error.message}`);
            }
        }

        // 解析章节列表
        function parseChapterList(html, baseUrl) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 常见的章节列表选择器
                const chapterSelectors = [
                    '.chapter-list a',
                    '.chapter a',
                    '.listmain a',
                    '.chapterlist a',
                    '#chapterlist a',
                    '.zhangjie a',
                    '.zjlist a',
                    'a[href*="chapter"]',
                    'a[href*="Chapter"]',
                    'a[href*="section"]',
                    'a[href*="Section"]'
                ];
                
                let chapterElements = [];
                
                // 尝试各种选择器
                for (const selector of chapterSelectors) {
                    chapterElements = doc.querySelectorAll(selector);
                    if (chapterElements.length > 0) {
                        break;
                    }
                }
                
                if (chapterElements.length === 0) {
                    // 如果没有找到，尝试获取所有链接并过滤
                    const allLinks = doc.querySelectorAll('a');
                    chapterElements = Array.from(allLinks).filter(link => {
                        const text = link.textContent.trim();
                        const href = link.getAttribute('href') || '';
                        
                        // 常见的章节标题模式
                        const chapterPatterns = [
                            /第[\d一二三四五六七八九十百千]+[章节卷集]/i,
                            /chapter[\s\d]+/i,
                            /section[\s\d]+/i
                        ];
                        
                        return chapterPatterns.some(pattern => 
                            pattern.test(text) || pattern.test(href)
                        );
                    });
                }
                
                // 提取章节信息
                const chapters = Array.from(chapterElements).map(element => {
                    let title = element.textContent.trim();
                    let href = element.getAttribute('href') || '';
                    
                    // 处理相对路径
                    if (href && !href.startsWith('http')) {
                        const base = new URL(baseUrl);
                        href = new URL(href, base).href;
                    }
                    
                    return {
                        title: title,
                        url: href,
                        isSelected: true
                    };
                }).filter(chapter => chapter.url); // 过滤掉没有URL的章节
                
                // 去重
                const uniqueChapters = [];
                const urls = new Set();
                
                for (const chapter of chapters) {
                    if (!urls.has(chapter.url)) {
                        urls.add(chapter.url);
                        uniqueChapters.push(chapter);
                    }
                }
                
                return uniqueChapters;
            } catch (error) {
                console.error('解析章节列表失败:', error);
                return [];
            }
        }

        // 提取小说标题
        function extractNovelTitle(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 常见的标题选择器
                const titleSelectors = [
                    'h1',
                    '.book-title',
                    '.novel-title',
                    '.bookname h1',
                    '.chaptertitle',
                    'title'
                ];
                
                for (const selector of titleSelectors) {
                    const element = doc.querySelector(selector);
                    if (element) {
                        let title = element.textContent.trim();
                        
                        // 清理标题
                        title = title.replace(/\s+/g, ' ');
                        title = title.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '');
                        title = title.replace(/(正文|全文阅读|最新章节)/g, '');
                        title = title.trim();
                        
                        if (title && title.length > 1 && title.length < 50) {
                            return title;
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('提取小说标题失败:', error);
                return null;
            }
        }

        // 提取小说作者
        function extractNovelAuthor(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 常见的作者信息选择器
                const authorSelectors = [
                    '.author',
                    '.book-author',
                    '.novel-author',
                    '.author-info',
                    'meta[name="author"]',
                    'meta[property="article:author"]'
                ];
                
                for (const selector of authorSelectors) {
                    const elements = doc.querySelectorAll(selector);
                    for (const element of elements) {
                        let author = '';
                        
                        if (element.tagName === 'META') {
                            author = element.getAttribute('content') || '';
                        } else {
                            author = element.textContent || '';
                        }
                        
                        author = author.trim();
                        
                        // 清理作者名
                        author = author.replace(/\s+/g, ' ');
                        author = author.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '');
                        author = author.replace(/(作者|著|文|by|By)/gi, '');
                        author = author.trim();
                        
                        if (author && author.length > 0 && author.length < 20) {
                            return author;
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('提取小说作者失败:', error);
                return null;
            }
        }

        // 渲染章节列表
        function renderChapterList() {
            elements.chapterList.innerHTML = '';
            
            if (!novelData.chapters || novelData.chapters.length === 0) {
                elements.chapterList.innerHTML = '<div class="p-4 text-center text-gray-500">未找到章节列表</div>';
                return;
            }
            
            const list = document.createElement('ul');
            list.className = 'divide-y divide-gray-200';
            
            novelData.chapters.forEach((chapter, index) => {
                const li = document.createElement('li');
                li.className = 'py-2 px-3 hover:bg-gray-50 transition-all-300';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `chapter-${index}`;
                checkbox.className = 'mr-2 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded';
                checkbox.checked = chapter.isSelected;
                
                checkbox.addEventListener('change', () => {
                    chapter.isSelected = checkbox.checked;
                    updateSelectedCount();
                });
                
                const label = document.createElement('label');
                label.htmlFor = `chapter-${index}`;
                label.className = 'flex items-center cursor-pointer text-sm text-gray-800 hover:text-primary';
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(chapter.title));
                
                li.appendChild(label);
                list.appendChild(li);
            });
            
            elements.chapterList.appendChild(list);
            
            // 更新计数
            elements.totalCount.textContent = novelData.chapters.length;
            updateSelectedCount();
        }

        // 更新已选择章节数
        function updateSelectedCount() {
            const selected = novelData.chapters.filter(chapter => chapter.isSelected).length;
            elements.selectedCount.textContent = selected;
        }

        // 全选章节
        function selectAllChapters() {
            novelData.chapters.forEach(chapter => {
                chapter.isSelected = true;
            });
            
            // 更新复选框状态
            document.querySelectorAll('#chapter-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            
            updateSelectedCount();
        }

        // 取消全选章节
        function selectNoneChapters() {
            novelData.chapters.forEach(chapter => {
                chapter.isSelected = false;
            });
            
            // 更新复选框状态
            document.querySelectorAll('#chapter-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateSelectedCount();
        }

        // 反选章节
        function selectReverseChapters() {
            novelData.chapters.forEach(chapter => {
                chapter.isSelected = !chapter.isSelected;
            });
            
            // 更新复选框状态
            document.querySelectorAll('#chapter-list input[type="checkbox"]').forEach((checkbox, index) => {
                checkbox.checked = novelData.chapters[index].isSelected;
            });
            
            updateSelectedCount();
        }

        // 开始抓取
        function startCrawl() {
            // 获取选中的章节
            const selectedChapters = novelData.chapters.filter(chapter => chapter.isSelected);
            
            if (selectedChapters.length === 0) {
                showError('请至少选择一个章节');
                return;
            }
            
            // 重置抓取状态
            crawlStatus = {
                isRunning: true,
                isPaused: false,
                currentChapter: 0,
                totalChapters: selectedChapters.length,
                selectedChapters: selectedChapters,
                retryCount: 0
            };
            
            // 清空之前的内容
            novelData.content = {};
            
            // 更新步骤指示器
            updateStepIndicator(3);
            
            // 显示步骤3
            showStep(3);
            
            // 重置进度
            elements.progressBar.style.width = '0%';
            elements.progressPercentage.textContent = '0%';
            elements.currentStatus.textContent = '开始抓取...';
            elements.currentChapter.textContent = '准备中...';
            
            // 清空日志
            elements.crawlLog.innerHTML = '<li class="text-gray-600"><i class="fa fa-info-circle text-blue-500 mr-1"></i> 开始抓取小说...</li>';
            
            // 显示暂停按钮
            elements.pauseCrawl.classList.remove('hidden');
            elements.resumeCrawl.classList.add('hidden');
            
            // 开始抓取章节
            crawlNextChapter();
        }

        // 抓取下一章
        async function crawlNextChapter() {
            if (!crawlStatus.isRunning || crawlStatus.isPaused) {
                return;
            }
            
            // 检查是否所有章节都已抓取完成
            if (crawlStatus.currentChapter >= crawlStatus.totalChapters) {
                finishCrawl();
                return;
            }
            
            // 获取当前章节
            const chapter = crawlStatus.selectedChapters[crawlStatus.currentChapter];
            
            // 更新状态
            elements.currentStatus.textContent = '正在抓取';
            elements.currentChapter.textContent = chapter.title;
            
            // 添加日志
            addLog(`正在抓取: ${chapter.title}`, 'info');
            
            try {
                // 抓取章节内容
                const content = await fetchChapterContent(chapter.url);
                
                // 保存内容
                novelData.content[chapter.title] = content;
                
                // 增加当前章节索引
                crawlStatus.currentChapter++;
                
                // 更新进度
                updateProgress();
                
                // 添加日志
                addLog(`抓取成功: ${chapter.title}`, 'success');
                
                // 重置重试计数
                crawlStatus.retryCount = 0;
                
                // 延迟后抓取下一章
                setTimeout(crawlNextChapter, novelData.settings.requestInterval);
                
            } catch (error) {
                console.error(`抓取章节失败: ${chapter.title}`, error);
                
                // 增加重试计数
                crawlStatus.retryCount++;
                
                // 检查是否超过最大重试次数
                if (crawlStatus.retryCount > novelData.settings.retryCount) {
                    addLog(`抓取失败: ${chapter.title} (已重试${novelData.settings.retryCount}次)`, 'error');
                    
                    // 继续下一章
                    crawlStatus.currentChapter++;
                    crawlStatus.retryCount = 0;
                    
                    // 更新进度
                    updateProgress();
                    
                    // 延迟后抓取下一章
                    setTimeout(crawlNextChapter, novelData.settings.requestInterval);
                } else {
                    addLog(`抓取失败: ${chapter.title} (正在重试... ${crawlStatus.retryCount}/${novelData.settings.retryCount})`, 'warning');
                    
                    // 延迟后重试
                    setTimeout(crawlNextChapter, novelData.settings.requestInterval * 2);
                }
            }
        }

        // 抓取章节内容
        async function fetchChapterContent(url) {
            try {
                const response = await fetchWithTimeout(url, {
                    method: 'GET',
                    headers: {
                        'User-Agent': novelData.settings.userAgent,
                        'Referer': novelData.url
                    }
                });
                
                const html = await response.text();
                
                // 解析章节内容
                const content = parseChapterContent(html);
                
                if (!content || content.trim() === '') {
                    throw new Error('无法提取章节内容');
                }
                
                return content;
            } catch (error) {
                console.error('抓取章节内容失败:', error);
                throw error;
            }
        }

        // 解析章节内容
        function parseChapterContent(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 常见的正文内容选择器
                const contentSelectors = [
                    '.content',
                    '.chapter-content',
                    '.novel-content',
                    '.content-body',
                    '.article-content',
                    '.text',
                    '#content',
                    '#chapter-content',
                    '#novel-content',
                    '#article-content',
                    '.yd_text2',
                    '.yd_text',
                    '.read-content',
                    '.chapter_text',
                    '.bookcontent',
                    '.content_text',
                    '.neirong',
                    '.nr_content',
                    '.chapterMain',
                    '.mainConten',
                    '.article',
                    'article',
                    '.chapter',
                    '.zhangjie'
                ];
                
                let contentElement = null;
                
                // 尝试各种选择器
                for (const selector of contentSelectors) {
                    contentElement = doc.querySelector(selector);
                    if (contentElement) {
                        // 检查内容长度，避免误选
                        const textLength = contentElement.textContent.trim().length;
                        if (textLength > 100) {
                            break;
                        }
                    }
                }
                
                // 如果没有找到合适的元素，尝试查找包含大量文本的div
                if (!contentElement) {
                    const divs = doc.querySelectorAll('div');
                    let maxTextLength = 0;
                    
                    for (const div of divs) {
                        const textLength = div.textContent.trim().length;
                        if (textLength > maxTextLength && textLength > 500) {
                            maxTextLength = textLength;
                            contentElement = div;
                        }
                    }
                }
                
                if (!contentElement) {
                    throw new Error('无法找到正文内容');
                }
                
                // 移除不需要的元素
                const unwantedElements = contentElement.querySelectorAll('script, style, iframe, img, video, audio, form, button, a, .advert, .ad, .chapter-control, .chapter-nav, .page-chapter, .pagebar, .chapterbottom, .readacfr, .acfr, .chapter-operation');
                unwantedElements.forEach(el => el.remove());
                
                // 获取纯文本内容
                let content = contentElement.textContent || '';
                
                // 清理文本
                content = content.trim();
                content = content.replace(/\s+/g, ' '); // 替换多个空格为单个空格
                content = content.replace(/\n+/g, '\n'); // 替换多个换行为单个换行
                content = content.replace(/\r+/g, ''); // 移除回车符
                content = content.replace(/&nbsp;/g, ' '); // 替换&nbsp;为空格
                content = content.replace(/\u3000/g, ' '); // 替换全角空格为半角空格
                
                // 移除首尾空白字符
                content = content.trim();
                
                // 分段处理
                const paragraphs = content.split(/[\n。！？.!?]/);
                content = paragraphs
                    .map(p => p.trim())
                    .filter(p => p.length > 0)
                    .join('\n\n');
                
                return content;
            } catch (error) {
                console.error('解析章节内容失败:', error);
                throw error;
            }
        }

        // 更新进度
        function updateProgress() {
            const progress = Math.round((crawlStatus.currentChapter / crawlStatus.totalChapters) * 100);
            elements.progressBar.style.width = `${progress}%`;
            elements.progressPercentage.textContent = `${progress}%`;
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const li = document.createElement('li');
            
            let iconClass = 'fa-info-circle text-blue-500';
            if (type === 'success') {
                iconClass = 'fa-check-circle text-green-500';
            } else if (type === 'warning') {
                iconClass = 'fa-exclamation-triangle text-yellow-500';
            } else if (type === 'error') {
                iconClass = 'fa-exclamation-circle text-red-500';
            }
            
            li.className = 'text-sm';
            li.innerHTML = `<i class="fa ${iconClass} mr-1"></i> ${message}`;
            
            elements.crawlLog.appendChild(li);
            
            // 滚动到底部
            elements.crawlLog.scrollTop = elements.crawlLog.scrollHeight;
        }

        // 暂停抓取
        function pauseCrawl() {
            crawlStatus.isPaused = true;
            elements.currentStatus.textContent = '已暂停';
            elements.pauseCrawl.classList.add('hidden');
            elements.resumeCrawl.classList.remove('hidden');
            addLog('抓取已暂停', 'warning');
        }

        // 继续抓取
        function resumeCrawl() {
            crawlStatus.isPaused = false;
            elements.currentStatus.textContent = '继续抓取';
            elements.resumeCrawl.classList.add('hidden');
            elements.pauseCrawl.classList.remove('hidden');
            addLog('继续抓取', 'info');
            crawlNextChapter();
        }

        // 停止抓取
        function stopCrawl() {
            crawlStatus.isRunning = false;
            crawlStatus.isPaused = false;
            elements.currentStatus.textContent = '已停止';
            elements.pauseCrawl.classList.add('hidden');
            elements.resumeCrawl.classList.add('hidden');
            addLog('抓取已停止', 'error');
            
            // 如果已经抓取了一些章节，询问是否下载
            if (Object.keys(novelData.content).length > 0) {
                setTimeout(() => {
                    if (confirm('已抓取部分章节，是否下载？')) {
                        finishCrawl();
                    } else {
                        backToStep1();
                    }
                }, 1000);
            } else {
                backToStep1();
            }
        }

        // 完成抓取
        function finishCrawl() {
            crawlStatus.isRunning = false;
            
            // 更新状态
            elements.currentStatus.textContent = '抓取完成';
            elements.pauseCrawl.classList.add('hidden');
            elements.resumeCrawl.classList.add('hidden');
            
            addLog(`抓取完成，共抓取 ${Object.keys(novelData.content).length} 章`, 'success');
            
            // 显示步骤4
            setTimeout(() => {
                // 更新小说信息
                elements.novelTitle.textContent = novelData.title;
                elements.novelAuthor.textContent = novelData.author;
                elements.crawledChapters.textContent = Object.keys(novelData.content).length;
                
                // 计算文件大小
                const fileSize = estimateFileSize();
                elements.fileSize.textContent = formatFileSize(fileSize);
                
                // 生成预览
                generatePreview();
                
                // 显示步骤4
                showStep(4);
                
                // 如果设置了自动保存，自动下载
                if (elements.autoSave.checked) {
                    setTimeout(downloadTxt, 1000);
                }
            }, 1500);
        }

        // 估计文件大小
        function estimateFileSize() {
            let totalSize = 0;
            
            for (const title in novelData.content) {
                totalSize += novelData.content[title].length;
            }
            
            // 加上标题和换行符的大小
            totalSize += Object.keys(novelData.content).length * 50;
            
            return totalSize;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) {
                return bytes + ' B';
            } else if (bytes < 1024 * 1024) {
                return (bytes / 1024).toFixed(2) + ' KB';
            } else {
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
        }

        // 生成预览
        function generatePreview() {
            const titles = Object.keys(novelData.content);
            
            if (titles.length === 0) {
                elements.contentPreview.textContent = '暂无内容';
                return;
            }
            
            // 取前几章的内容作为预览
            let preview = '';
            const previewChapters = Math.min(3, titles.length);
            
            for (let i = 0; i < previewChapters; i++) {
                const title = titles[i];
                const content = novelData.content[title];
                
                preview += `第${i + 1}章 ${title}\n\n`;
                
                // 取前200个字符
                if (content.length > 200) {
                    preview += content.substring(0, 200) + '...\n\n';
                } else {
                    preview += content + '\n\n';
                }
            }
            
            elements.contentPreview.textContent = preview;
        }

        // 下载TXT文件
        function downloadTxt() {
            if (Object.keys(novelData.content).length === 0) {
                alert('没有可下载的内容');
                return;
            }
            
            // 生成TXT内容
            let txtContent = `${novelData.title}\n作者：${novelData.author}\n\n`;
            
            const titles = Object.keys(novelData.content);
            
            for (let i = 0; i < titles.length; i++) {
                const title = titles[i];
                const content = novelData.content[title];
                
                txtContent += `第${i + 1}章 ${title}\n\n`;
                txtContent += content + '\n\n';
            }
            
            // 创建Blob对象
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${novelData.title}.txt`;
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
            
            addLog('TXT文件下载已开始', 'success');
        }

        // 返回步骤1
        function backToStep1() {
            // 重置状态
            crawlStatus.isRunning = false;
            crawlStatus.isPaused = false;
            
            // 重置步骤指示器
            updateStepIndicator(1);
            
            // 显示步骤1
            showStep(1);
            
            // 清空URL输入框
            elements.novelUrl.value = '';
            
            // 重置小说数据
            novelData.chapters = [];
            novelData.content = {};
        }

        // 更新步骤指示器
        function updateStepIndicator(activeStep) {
            // 重置所有指示器
            [elements.step1Indicator, elements.step2Indicator, elements.step3Indicator].forEach(indicator => {
                indicator.querySelector('div').className = 'w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center mb-2';
                indicator.querySelector('span').className = 'text-sm font-medium text-gray-500';
            });
            
            // 重置连接线
            [elements.step12Line, elements.step23Line].forEach(line => {
                line.className = 'flex-1 border-t-2 border-gray-300 self-center mx-2';
            });
            
            // 更新活动步骤
            if (activeStep >= 1) {
                elements.step1Indicator.querySelector('div').className = 'w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center mb-2';
                elements.step1Indicator.querySelector('span').className = 'text-sm font-medium text-primary';
            }
            
            if (activeStep >= 2) {
                elements.step2Indicator.querySelector('div').className = 'w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center mb-2';
                elements.step2Indicator.querySelector('span').className = 'text-sm font-medium text-primary';
                elements.step12Line.className = 'flex-1 border-t-2 border-primary self-center mx-2';
            }
            
            if (activeStep >= 3) {
                elements.step3Indicator.querySelector('div').className = 'w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center mb-2';
                elements.step3Indicator.querySelector('span').className = 'text-sm font-medium text-primary';
                elements.step23Line.className = 'flex-1 border-t-2 border-primary self-center mx-2';
            }
        }

        // 显示指定步骤
        function showStep(stepNumber) {
            // 隐藏所有步骤
            Object.values(steps).forEach(step => {
                step.classList.add('hidden');
            });
            
            // 显示指定步骤
            if (stepNumber === 1) {
                steps.step1.classList.remove('hidden');
            } else if (stepNumber === 2) {
                steps.step2.classList.remove('hidden');
            } else if (stepNumber === 3) {
                steps.step3.classList.remove('hidden');
            } else if (stepNumber === 4) {
                steps.step4.classList.remove('hidden');
            }
        }

        // 显示错误信息
        function showError(message) {
            elements.errorText.textContent = message;
            elements.errorMessage.classList.remove('hidden');
            
            // 5秒后自动隐藏
            setTimeout(() => {
                elements.errorMessage.classList.add('hidden');
            }, 5000);
        }

        // 隐藏错误信息
        function hideError() {
            elements.errorMessage.classList.add('hidden');
        }

        // 带超时的fetch
        async function fetchWithTimeout(url, options = {}, timeout = novelData.settings.timeout * 1000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                
                clearTimeout(id);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response;
            } catch (error) {
                clearTimeout(id);
                
                if (error.name === 'AbortError') {
                    throw new Error('请求超时');
                }
                
                throw error;
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>